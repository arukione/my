---
title: 天翼校园网验证码识别
date: 2019-5-25
tags: 
    - 神经网络
    - Python
categories: AI
top: 9809475
---

**本菜鸡能力有限，本文章主要目的是为了完成自动登录校园网，不是为了教学......**
**依靠之前学的一个神经网络，尝试写一个识别天翼验证码的代码**
其实是为了破解那个不得不吐槽的校园网，不得不捣鼓的东西......

**如果不懂爬虫，神经网络的构造，梯度下降算法和反向传播算法，请先找资料学习相关知识，网上有很多讲解的文章，B站也有很多视频**

**首先训练神经网络需要一点训练数据，而且，写的那个神经网络也不是靠深度学习框架的，所以识别的时候是采取分别识别验证码里面的4个数字的方式。**
**幸好，天翼的验证码里的数字，非常简单，没有那些奇奇怪怪的加工，每个数字都是一样的，所以训练数据也不用那么多。**
**写一个爬虫抓取一下验证码图片，然后把图片分割一下，就可以得到训练数据了。**
**因为验证码里面的数字都长得一样，这里我每个数字就只用了10张图片来训练**
<img src="\images\天翼验证码训练集图片.png" alt="训练数据数字0~9"/>

**接下来是训练神经网络**
```
class neuralNetwork():

    # 初始化神经网络
    def __init__(self):
        # 定义输入层节点数量
        self.inputnodes = 13 * 9
        # 定义隐藏层节点数量
        self.hiddennodes = 300
        # 定义输出层节点数量
        self.outnodes = 10
        # 随机初始化权重
        self.input_hidden_weight = random.normal(0.0, pow(self.hiddennodes, -0.5), (self.hiddennodes, self.inputnodes))
        self.hidden_out_weight = random.normal(0.0, pow(self.outnodes, -0.5), (self.outnodes, self.hiddennodes))
        # 设置学习率
        self.learning_rate = 0.1
        # 定义激活函数
        self.activation_function = lambda x: expit(x)

    def train(self, inputs, targets):
        """
        :param inputs: 输入的图片数组
        :param targets: 预测得到的结果
        """
        # 转化输入的数据
        inputs = nparray(inputs, ndmin=2).T
        # 转化预测的数据
        targets = nparray(targets, ndmin=2).T
        # 神经网络的识别结果
        hidden_inputs = dot(self.input_hidden_weight, inputs)
        hidden_outputs = self.activation_function(hidden_inputs)
        out_inputs = dot(self.hidden_out_weight, hidden_outputs)
        final_outputs = self.activation_function(out_inputs)
        # 分配输出层、隐藏层的各节的损失值
        out_error = targets - final_outputs
        hidden_error = dot(self.hidden_out_weight.T, out_error)
        # 更新权重
        self.hidden_out_weight += self.learning_rate * dot((out_error * final_outputs * (1.0 - final_outputs)),
                                                           hidden_outputs.T)
        self.input_hidden_weight += self.learning_rate * dot((hidden_error * hidden_outputs * (1.0 - hidden_outputs)),
                                                             inputs.T)

    def query(self, inputs):
        inputs = nparray(inputs, ndmin=2).T
        hidden_inputs = dot(self.input_hidden_weight, inputs)
        hidden_outputs = self.activation_function(hidden_inputs)
        out_inputs = dot(self.hidden_out_weight, hidden_outputs)
        final_outputs = self.activation_function(out_inputs)
        max = argmax(final_outputs)
        return max
```

**用这个类代表神经网络，激活函数是使用sigmoid函数,这个函数在python里面已经内置在scipy库里面了，直接调用scipy.special的expit()函数就可以了**
**query函数是神经网络识别图片函数，train函数是训练神经网络的函数，训练时用的算法是梯度下降和反向传播。**
**把分割的数字图片转化为numpy数据传入train方法就可以对神经网络进行训练。**
**权重更新方式使用梯度下降算法来获取更优的权重**
**以下是图片的转化函数**
```
def get_data(image, select):
    """
    转化图片数据
    :param image: 图片
    :param select: 0代表输入整张验证码，返回4个数字的3维numpy数组    1代表输入一个数字，返回一个2维的numpy数组
    :return: data or imdata
    """
    if select == 0:
        # 分割图片
        numdata = []
        number = image.crop((7, 3, 55, 16)).convert('L')
        num1 = number.crop((0, 0, 9, 13))
        num2 = number.crop((13, 0, 22, 13))
        num3 = number.crop((26, 0, 35, 13))
        num4 = number.crop((39, 0, 48, 13))
        numlist = [num1, num2, num3, num4]
        for num in numlist:
            two = num.convert('1')
            array = nparray(two)
            list = array.tolist()
            data = []
            for l in list:
                for i in l:
                    data.append(i)
            numdata.append(data)
        data = nparray(numdata) * 0.89 + 0.1
        return data
    if select == 1:
        two = image.convert('1')
        array = nparray(two)
        list = array.tolist()
        data = []
        for l in list:
            for i in l:
                data.append(i)
        imdata = nparray(data) * 0.89 + 0.1
        return imdata
```

**以下是我用到的训练函数**
```
def network_train(network):
    for ii in range(0, 11):
        for i in range(0, 10):
            image = Image.open("number/" + str(i) + "/" + str(ii) + ".jpg")
            inputs = get_data(image, 1)
            targes = zeros(10) + 0.1
            targes[i] = 0.99
            network.train(inputs, targes)
    try:
        os.remove('input_hidden_weight.txt')
        os.remove('hidden_out_weight.txt')
        print('重置权重文件')
    except:
        print('创建权重文件')
    savetxt("input_hidden_weight.txt", network.input_hidden_weight)
    savetxt("hidden_out_weight.txt", network.hidden_out_weight)
```

**因为这个验证码很简单，所以我没打算分测试数据，把全部图片训练完，这个神经网络就可以调用query方法来识别验证码了。**
**为了不用每次识别验证码都训练一次，我在把训练出来的模型的权重保存在文件里面，以便以后直接拿文件里面的模型来用。**

**代码文件、训练数据、模型权重文件，我都放在github里面**

github代码链接：
https://github.com/arukione/verification-code/tree/master/%E5%A4%A9%E7%BF%BC%E6%A0%A1%E5%9B%AD%E7%BD%91%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB
