---
title: 开发记录-服务器发送的响应无效
date: 2020-3-14
categories: 开发记录
tags:
    - Spring Boot
---

在修改了 Spring Boot 文件放回时文件名称的代码吼, 网页发送文件下载请求时, 出现了

```Text
该网页无法正常运作
xxx 发送的请求无效
ERR_RESPONSE_HEADERS_MULTIPLE_CONTENT_DISPOSITION
```

当我选择另一个类别进行下载时, 又发现没问题, 所以把问题的定位到了文件名的配置上面去
<!--more-->
下面是请求处理我的代码

```Java

@GetMapping("/downZip/{activity}/{collegename}")
public ResponseEntity<FileSystemResource> downZip(@PathVariable String activity, @PathVariable String collegename) throws IOException {

    FileSystemResource file = new FileSystemResource("/www/website/contribute/static/" + activity + "/" + collegename + ".zip");

    String zipName = activity + "-" + collegename + ".zip";

    HttpHeaders headers = new HttpHeaders();
    headers.add("Cache-Control", "no-cache, no-store, must-revalidate");
    headers.add("Content-Disposition", "attachment; filename=" + new String(zipName.getBytes(StandardCharsets.UTF_8), StandardCharsets.ISO_8859_1));
    headers.add("Pragma", "no-cache");
    headers.add("Expires", "0");
    headers.add("Last-Modified", new Date().toString());
    headers.add("ETag", String.valueOf(System.currentTimeMillis()));

    return ResponseEntity
            .ok()
            .headers(headers)
            .contentLength(file.contentLength())
            .contentType(MediaType.parseMediaType("application/octet-stream"))
            .body(file);
```

可以看到文件名是根据的配置是这两句

```Java
String zipName = activity + "-" + collegename + ".zip";
headers.add("Content-Disposition", "attachment; filename=" + new String(zipName.getBytes(StandardCharsets.UTF_8), StandardCharsets.ISO_8859_1));
```

也就是说我下载的文件名是根据 activity（活动名称）和 collegename 这两个传入的值来进行命名的, 但是我发现在项目的活动里面, 有一个活动名称是带有双引号的, 在发送请求时, 传入的 activity 里面是有双引号的

根据响应头的的规则应该是这样的`Content-Disposition: attachment; filename="文件名"`
当我传入的字符串带有未转义的双引号, 就会导致拼接后的响应头的格式出错, 从而返回无效的响应

因为我还没找到处理这个双引号的方法, 所以我把文件名里的 activity 给去掉了, 这样就可以暂时解决问题了
